name: Infra Security Scan
on: [push]

jobs:
  infra_audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Dockerfile Config Scan (Official Action - No Install Needed)
      - name: Run Trivy Config Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'frontend/Dockerfile'
          format: 'table'
          output: 'config_result.txt'
          severity: 'HIGH,CRITICAL'

      # 2. Build Image
      - name: Build Image
        run: |
          docker build -t symphony-infra:test -f frontend/Dockerfile .

      # 3. OS Vulnerabilities Scan (Official Action)
      - name: Run Trivy Image Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'symphony-infra:test'
          scan-type: 'image'
          vuln-type: 'os'
          format: 'table'
          output: 'os_result.txt'
          severity: 'HIGH,CRITICAL'

      # 4. Notify Google Chat
      - name: Notify Google Chat
        if: always()
        run: |
          # Reports ko read karke env variable mein dalna
          CONFIG_OUT=$(cat config_result.txt | head -c 1500)
          OS_OUT=$(cat os_result.txt | head -c 1500)
          
          curl -X POST "${{ secrets.GOOGLE_CHAT_WEBHOOK }}" \
          -H 'Content-Type: application/json' \
          -d "{\"text\": \"*Trivy Infra Scan Report*\n\n*Dockerfile Errors:* \n\`\`\`$CONFIG_OUT\`\`\` \n\n*OS Bugs:* \n\`\`\`$OS_OUT\`\`\"}"